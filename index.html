<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="theme-color" content="#08071a"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="EventSpot"/>
  <title>EventSpot ZÃ¼rich</title>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icon-192.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet"/>

  <script>
    window.MAPS_KEY = "AIzaSyB_fNBv6ZLw5wm9fKwGeJ12L4p6sVM0hQg";
    window.FB = {
      apiKey: "AIzaSyAg6oTGoJa_Yp7flssU5OpyXvJ2KxoA0yA",
      authDomain: "eventspot-zurich.firebaseapp.com",
      projectId: "eventspot-zurich",
      storageBucket: "eventspot-zurich.firebasestorage.app",
      messagingSenderId: "210810461333",
      appId: "1:210810461333:web:1c8283baba7e0fef364f9c"
    };
  </script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #08071a;
      --surface: #12103a;
      --elevated: #1e1b4b;
      --border: rgba(255,255,255,0.07);
      --accent: #7c5cfc;
      --accent2: #a78bfa;
      --cyan: #22d3ee;
      --green: #34d399;
      --red: #f87171;
      --orange: #fb923c;
      --text: #e2e0ff;
      --muted: #7c78a0;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; overscroll-behavior: none; }
    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
    }
    button { font-family: inherit; cursor: pointer; border: none; background: none; }

    /* â”€â”€ MAP (PERSISTENT â€“ never replaced) â”€â”€ */
    #map {
      position: fixed; inset: 0;
      width: 100%; height: 100%;
      z-index: 0;
    }

    /* â”€â”€ UI OVERLAY â”€â”€ */
    #ui {
      position: fixed; inset: 0;
      pointer-events: none;
      z-index: 10;
      display: flex;
      flex-direction: column;
    }
    #ui > * { pointer-events: auto; }

    /* â”€â”€ HEADER â”€â”€ */
    #header-zone {
      padding: calc(var(--safe-top) + 12px) 16px 0;
    }
    .header {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      font-family: 'Syne', sans-serif;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--text);
    }
    .logo span { color: var(--accent2); }

    .header-actions { display: flex; gap: 8px; align-items: center; }

    .btn-icon {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: rgba(30, 27, 75, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 18px;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .btn-icon:active { background: var(--elevated); }

    .user-avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--cyan));
      display: flex; align-items: center; justify-content: center;
      font-family: 'Syne', sans-serif;
      font-size: 15px;
      font-weight: 700;
      border: 2px solid rgba(255,255,255,0.15);
    }

    /* â”€â”€ FILTER TABS â”€â”€ */
    .filter-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      display: flex;
      gap: 8px;
      padding: 2px 0 4px;
    }
    .filter-scroll::-webkit-scrollbar { display: none; }

    .tab {
      flex-shrink: 0;
      height: 36px;
      padding: 0 14px;
      border-radius: 18px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      display: flex; align-items: center; gap: 5px;
      background: rgba(18, 16, 58, 0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      color: var(--muted);
      transition: all 0.18s;
      white-space: nowrap;
    }
    .tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
      font-weight: 600;
    }
    .tab .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: currentColor;
    }
    .tab.live-tab.active { background: #ef4444; border-color: #ef4444; }
    .tab.ai-tab.active { background: linear-gradient(135deg, #0ea5e9, #22d3ee); border-color: #22d3ee; }

    /* â”€â”€ SPACER â”€â”€ */
    #ui-spacer { flex: 1; pointer-events: none; }

    /* â”€â”€ FAB (Add Event) â”€â”€ */
    #fab-zone {
      padding: 0 16px calc(var(--safe-bot) + 90px);
      display: flex;
      justify-content: flex-end;
    }
    .fab {
      width: 56px; height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #9333ea);
      box-shadow: 0 4px 20px rgba(124, 92, 252, 0.5);
      color: #fff;
      font-size: 26px;
      display: flex; align-items: center; justify-content: center;
      border: none;
      transition: transform 0.18s, box-shadow 0.18s;
    }
    .fab:active { transform: scale(0.93); box-shadow: 0 2px 10px rgba(124, 92, 252, 0.4); }

    /* â”€â”€ LOCATE BUTTON â”€â”€ */
    #locate-zone {
      padding: 0 16px 12px;
      display: flex;
      justify-content: flex-end;
    }

    /* â”€â”€ BOTTOM CARD (Event detail) â”€â”€ */
    #card-zone {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 20;
      pointer-events: auto;
    }
    .event-card {
      background: rgba(18, 16, 58, 0.97);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      border-top: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      padding: 16px 20px calc(var(--safe-bot) + 20px);
      animation: slideUp 0.28s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .card-handle {
      width: 36px; height: 4px;
      border-radius: 2px;
      background: var(--border);
      margin: 0 auto 16px;
    }
    .card-cat-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .cat-pill {
      display: flex; align-items: center; gap: 5px;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid;
    }
    .live-badge {
      display: flex; align-items: center; gap: 4px;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .live-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: #f87171;
      animation: blink 1.4s ease-in-out infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.2; }
    }
    .card-title {
      font-family: 'Syne', sans-serif;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 6px;
      line-height: 1.2;
    }
    .card-time {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .card-desc {
      font-size: 14px;
      color: var(--text);
      opacity: 0.8;
      line-height: 1.5;
      margin-bottom: 16px;
    }
    .card-poster {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 14px;
    }

    /* Vote section */
    .vote-section {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }
    .vote-btn {
      flex: 1;
      padding: 11px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.18s;
      border: 1.5px solid;
    }
    .vote-btn.confirm {
      background: rgba(52, 211, 153, 0.1);
      border-color: rgba(52, 211, 153, 0.3);
      color: var(--green);
    }
    .vote-btn.confirm:active, .vote-btn.confirm.selected {
      background: rgba(52, 211, 153, 0.25);
      border-color: var(--green);
    }
    .vote-btn.decline {
      background: rgba(248, 113, 113, 0.1);
      border-color: rgba(248, 113, 113, 0.3);
      color: var(--red);
    }
    .vote-btn.decline:active, .vote-btn.decline.selected {
      background: rgba(248, 113, 113, 0.25);
      border-color: var(--red);
    }
    .vote-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .vote-count {
      font-size: 16px;
      font-weight: 700;
    }
    .vote-voted-msg {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      margin-top: 8px;
    }

    .card-close {
      position: absolute;
      top: 16px; right: 20px;
      color: var(--muted);
      font-size: 20px;
      width: 30px; height: 30px;
      display: flex; align-items: center; justify-content: center;
    }

    /* â”€â”€ MODAL â”€â”€ */
    #modal-zone {
      position: fixed; inset: 0;
      z-index: 50;
      display: flex; align-items: flex-end;
    }
    .modal-backdrop {
      position: absolute; inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-sheet {
      position: relative;
      width: 100%;
      background: var(--surface);
      border-radius: 24px 24px 0 0;
      border-top: 1px solid var(--border);
      padding: 16px 20px calc(var(--safe-bot) + 24px);
      animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-title {
      font-family: 'Syne', sans-serif;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
    }

    /* Form fields */
    .form-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      display: block;
    }
    .form-field {
      width: 100%;
      background: var(--elevated);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      margin-bottom: 16px;
      outline: none;
      transition: border-color 0.18s;
    }
    .form-field:focus { border-color: var(--accent); }
    textarea.form-field { resize: none; min-height: 80px; }

    /* Category grid in modal */
    .cat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    .cat-btn {
      padding: 10px 6px;
      border-radius: 12px;
      background: var(--elevated);
      border: 1.5px solid var(--border);
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.18s;
    }
    .cat-btn .cat-emoji { font-size: 20px; }
    .cat-btn.selected {
      border-color: var(--accent);
      background: rgba(124, 92, 252, 0.15);
      color: var(--accent2);
    }

    /* Type toggle */
    .type-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .type-btn {
      flex: 1;
      padding: 10px;
      border-radius: 12px;
      background: var(--elevated);
      border: 1.5px solid var(--border);
      color: var(--muted);
      font-size: 13px;
      font-weight: 500;
      transition: all 0.18s;
    }
    .type-btn.selected {
      border-color: var(--accent);
      background: rgba(124, 92, 252, 0.15);
      color: var(--accent2);
    }

    .btn-primary {
      width: 100%;
      padding: 15px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), #9333ea);
      color: #fff;
      font-family: 'Syne', sans-serif;
      font-size: 16px;
      font-weight: 700;
      margin-top: 4px;
      transition: opacity 0.18s, transform 0.18s;
    }
    .btn-primary:active { opacity: 0.85; transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.4; }

    /* â”€â”€ AUTH SCREEN â”€â”€ */
    #auth-zone {
      position: fixed; inset: 0;
      z-index: 100;
      background: var(--bg);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 32px 24px;
      text-align: center;
    }
    .auth-logo {
      font-family: 'Syne', sans-serif;
      font-size: 48px;
      font-weight: 800;
      margin-bottom: 8px;
    }
    .auth-logo span { color: var(--accent2); }
    .auth-sub {
      font-size: 15px;
      color: var(--muted);
      margin-bottom: 48px;
    }
    .btn-google {
      width: 100%;
      max-width: 320px;
      padding: 16px;
      border-radius: 16px;
      background: #fff;
      color: #111;
      font-family: 'DM Sans', sans-serif;
      font-size: 16px;
      font-weight: 600;
      display: flex; align-items: center; justify-content: center; gap: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
      transition: transform 0.18s;
    }
    .btn-google:active { transform: scale(0.97); }
    .btn-google svg { width: 22px; height: 22px; flex-shrink: 0; }
    .auth-skip {
      margin-top: 16px;
      color: var(--muted);
      font-size: 14px;
      text-decoration: underline;
      background: none;
      border: none;
      cursor: pointer;
    }

    /* â”€â”€ SPLASH â”€â”€ */
    #splash {
      position: fixed; inset: 0;
      z-index: 200;
      background: var(--bg);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 12px;
      transition: opacity 0.5s, visibility 0.5s;
    }
    #splash.out { opacity: 0; visibility: hidden; }
    .splash-logo {
      font-family: 'Syne', sans-serif;
      font-size: 42px;
      font-weight: 800;
    }
    .splash-logo span { color: var(--accent2); }
    .splash-sub { font-size: 14px; color: var(--muted); }
    .splash-spinner {
      width: 28px; height: 28px;
      border: 2.5px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-top: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ TOAST â”€â”€ */
    #toast-zone {
      position: fixed;
      top: calc(var(--safe-top) + 100px);
      left: 50%; transform: translateX(-50%);
      z-index: 150;
      pointer-events: none;
    }
    .toast {
      background: var(--elevated);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 20px;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      animation: toastAnim 0.3s;
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
    }
    @keyframes toastAnim { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: none; } }

    /* â”€â”€ LOCATION ACCURACY INDICATOR â”€â”€ */
    .loc-accuracy {
      position: fixed;
      bottom: calc(var(--safe-bot) + 100px);
      left: 16px;
      background: rgba(18, 16, 58, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 6px 12px;
      font-size: 11px;
      color: var(--muted);
      z-index: 15;
      pointer-events: none;
    }
  </style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="splash-logo">Event<span>Spot</span></div>
  <div class="splash-sub">ZÃ¼rich Â· Live Events entdecken</div>
  <div class="splash-spinner"></div>
</div>

<!-- MAP â€” persistent, never touched by JS re-renders -->
<div id="map"></div>

<!-- UI floating on top -->
<div id="ui">
  <div id="header-zone"></div>
  <div id="ui-spacer"></div>
  <div id="locate-zone">
    <button class="btn-icon" onclick="locateUser()" title="Mein Standort">ğŸ“</button>
  </div>
  <div id="fab-zone">
    <button class="fab" onclick="openAddEvent()" title="Event melden">+</button>
  </div>
</div>

<!-- Dynamic zones (safe to replace innerHTML) -->
<div id="card-zone"></div>
<div id="modal-zone"></div>
<div id="toast-zone"></div>
<div id="auth-zone"></div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CATS = {
  music:     { emoji: 'ğŸµ', label: 'Musik',       color: '#e040fb' },
  food:      { emoji: 'ğŸ”', label: 'Essen',        color: '#ff6d00' },
  bonfire:   { emoji: 'ğŸ”¥', label: 'Feuer',        color: '#ff5722' },
  party:     { emoji: 'ğŸ‰', label: 'Party',        color: '#d500f9' },
  community: { emoji: 'ğŸ‘¥', label: 'Community',    color: '#00b0ff' },
  protest:   { emoji: 'ğŸ“¢', label: 'Demo',         color: '#ff1744' },
  market:    { emoji: 'ğŸ›’', label: 'Markt',        color: '#00c853' },
  sport:     { emoji: 'âš½', label: 'Sport',        color: '#2979ff' },
  art:       { emoji: 'ğŸ¨', label: 'Kunst',        color: '#aa00ff' },
  ai:        { emoji: 'ğŸ¤–', label: 'AI Event',     color: '#22d3ee' },
};

const FILTERS = [
  { id: 'all',         label: 'Alle',       icon: 'ğŸ—ºï¸' },
  { id: 'spontaneous', label: 'Live',       icon: 'ğŸ”´', cls: 'live-tab' },
  { id: 'planned',     label: 'Geplant',   icon: 'ğŸ“…' },
  { id: 'ai',          label: 'AI Events',  icon: 'ğŸ¤–', cls: 'ai-tab' },
];

const MAP_STYLE = [
  {elementType:'geometry',stylers:[{color:'#0e0c20'}]},
  {elementType:'labels.text.fill',stylers:[{color:'#7b7fa8'}]},
  {elementType:'labels.text.stroke',stylers:[{color:'#0e0c20'}]},
  {featureType:'landscape',elementType:'geometry',stylers:[{color:'#12103a'}]},
  {featureType:'landscape.man_made',elementType:'geometry.stroke',stylers:[{color:'#1e1b4b'}]},
  {featureType:'poi',elementType:'geometry',stylers:[{color:'#1a183a'}]},
  {featureType:'poi',elementType:'labels.text.fill',stylers:[{color:'#6f6d94'}]},
  {featureType:'poi.park',elementType:'geometry.fill',stylers:[{color:'#0a1f0a'}]},
  {featureType:'poi.park',elementType:'labels.text.fill',stylers:[{color:'#3c6040'}]},
  {featureType:'road',elementType:'geometry',stylers:[{color:'#1e1b4b'}]},
  {featureType:'road',elementType:'labels.text.fill',stylers:[{color:'#6f6d94'}]},
  {featureType:'road.arterial',elementType:'geometry',stylers:[{color:'#252157'}]},
  {featureType:'road.highway',elementType:'geometry',stylers:[{color:'#2d2870'}]},
  {featureType:'road.highway',elementType:'geometry.stroke',stylers:[{color:'#1e1b4b'}]},
  {featureType:'road.highway',elementType:'labels.text.fill',stylers:[{color:'#8b89b5'}]},
  {featureType:'transit',elementType:'geometry',stylers:[{color:'#1a183a'}]},
  {featureType:'transit.station',elementType:'labels.text.fill',stylers:[{color:'#6f6d94'}]},
  {featureType:'water',elementType:'geometry.fill',stylers:[{color:'#06040f'}]},
  {featureType:'water',elementType:'labels.text.fill',stylers:[{color:'#3d3b5a'}]},
];

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let gmap = null;
let mapReady = false;
let markers = {};        // eventId â†’ google.maps.Marker
let userMarker = null;
let userLat = 47.3769, userLng = 8.5417;
let events = [];
let user = null;

let S = {
  filter: 'all',
  selectedId: null,
  addModal: false,
  addForm: { name: '', description: '', time: '', category: 'music', type: 'spontaneous' },
};

// â”€â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
firebase.initializeApp(window.FB);
const auth = firebase.auth();
const db = firebase.firestore();

// â”€â”€â”€ VOTES (localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getVotes() {
  try { return JSON.parse(localStorage.getItem('es_votes') || '{}'); } catch { return {}; }
}
function saveVote(eventId, vote) {
  const v = getVotes();
  v[eventId] = vote;
  localStorage.setItem('es_votes', JSON.stringify(v));
}
function myVote(eventId) {
  return getVotes()[eventId] || null;
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg) {
  clearTimeout(toastTimer);
  const z = document.getElementById('toast-zone');
  z.innerHTML = `<div class="toast">${msg}</div>`;
  toastTimer = setTimeout(() => { z.innerHTML = ''; }, 2500);
}

// â”€â”€â”€ MARKER SVG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function markerSVG(category, isLive) {
  const cat = CATS[category] || CATS.community;
  const color = cat.color;
  const emoji = cat.emoji;
  const pulse = isLive ? `
    <circle cx="22" cy="22" r="20" fill="none" stroke="${color}" stroke-width="1.5" opacity="0.7">
      <animate attributeName="r" values="20;28;20" dur="1.8s" repeatCount="indefinite"/>
      <animate attributeName="opacity" values="0.7;0;0.7" dur="1.8s" repeatCount="indefinite"/>
    </circle>` : '';
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 44 44">
    ${pulse}
    <circle cx="22" cy="22" r="16" fill="${color}" fill-opacity="0.2"/>
    <circle cx="22" cy="22" r="13" fill="${color}"/>
    <text x="22" y="27" text-anchor="middle" font-size="14" font-family="Apple Color Emoji,Segoe UI Emoji,sans-serif">${emoji}</text>
  </svg>`;
  return {
    url: `data:image/svg+xml,${encodeURIComponent(svg)}`,
    scaledSize: new google.maps.Size(44, 44),
    anchor: new google.maps.Point(22, 22),
  };
}

// â”€â”€â”€ MAP MARKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearMarkers() {
  Object.values(markers).forEach(m => m.setMap(null));
  markers = {};
}

function renderMarkers() {
  if (!mapReady) return;
  clearMarkers();
  const filtered = filteredEvents();
  filtered.forEach(ev => {
    const isLive = ev.type === 'spontaneous';
    const marker = new google.maps.Marker({
      position: { lat: ev.lat, lng: ev.lng },
      map: gmap,
      icon: markerSVG(ev.category, isLive),
      title: ev.name,
      optimized: false,   // needed for SVG animations
    });
    marker.addListener('click', () => selectEvent(ev.id));
    markers[ev.id] = marker;
  });
}

function filteredEvents() {
  if (S.filter === 'all') return events;
  if (S.filter === 'ai') return events.filter(e => e.type === 'ai' || e.category === 'ai');
  return events.filter(e => e.type === S.filter);
}

// â”€â”€â”€ EVENT SELECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectEvent(id) {
  S.selectedId = id;
  renderCard();
  const ev = events.find(e => e.id === id);
  if (ev && gmap) gmap.panTo({ lat: ev.lat, lng: ev.lng });
}

function closeCard() {
  S.selectedId = null;
  renderCard();
}

// â”€â”€â”€ RENDER: HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHeader() {
  const z = document.getElementById('header-zone');
  const avatar = user
    ? `<div class="user-avatar">${(user.displayName||user.email||'U')[0].toUpperCase()}</div>`
    : `<button class="btn-icon" onclick="showAuth()" title="Anmelden">ğŸ‘¤</button>`;

  const tabs = FILTERS.map(f => {
    const cls = ['tab', f.cls || '', f.id === S.filter ? 'active' : ''].filter(Boolean).join(' ');
    return `<button class="${cls}" onclick="setFilter('${f.id}')">${f.icon} ${f.label}</button>`;
  }).join('');

  z.innerHTML = `
    <div class="header">
      <div class="header-top">
        <div class="logo">Event<span>Spot</span> <span style="font-size:14px;font-weight:400;color:var(--muted)">ZÃ¼rich</span></div>
        <div class="header-actions">${avatar}</div>
      </div>
      <div class="filter-scroll">${tabs}</div>
    </div>`;
}

// â”€â”€â”€ RENDER: CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCard() {
  const z = document.getElementById('card-zone');
  if (!S.selectedId) { z.innerHTML = ''; return; }
  const ev = events.find(e => e.id === S.selectedId);
  if (!ev) { z.innerHTML = ''; return; }

  const cat = CATS[ev.category] || CATS.community;
  const isLive = ev.type === 'spontaneous';
  const voted = myVote(ev.id);

  const liveBadge = isLive
    ? `<div class="live-badge"><div class="live-dot"></div> LIVE</div>`
    : '';

  const catPill = `<div class="cat-pill" style="color:${cat.color};border-color:${cat.color}30;background:${cat.color}18">
    ${cat.emoji} ${cat.label}
  </div>`;

  let voteHTML;
  if (voted) {
    voteHTML = `
      <div class="vote-section">
        <div class="vote-btn confirm ${voted === 'confirmed' ? 'selected' : 'disabled'}" style="flex:1">
          âœ“ Real <span class="vote-count">${ev.confirmed || 0}</span>
        </div>
        <div class="vote-btn decline ${voted === 'declined' ? 'selected' : 'disabled'}" style="flex:1">
          âœ— Falsch <span class="vote-count">${ev.declined || 0}</span>
        </div>
      </div>
      <div class="vote-voted-msg">Du hast bereits abgestimmt Â· Danke!</div>`;
  } else {
    const canVote = !!user;
    voteHTML = `
      <div class="vote-section">
        <button class="vote-btn confirm ${canVote ? '' : 'disabled'}"
          onclick="${canVote ? `castVote('${ev.id}','confirmed')` : "showToast('Bitte erst anmelden')"}">
          âœ“ Real <span class="vote-count">${ev.confirmed || 0}</span>
        </button>
        <button class="vote-btn decline ${canVote ? '' : 'disabled'}"
          onclick="${canVote ? `castVote('${ev.id}','declined')` : "showToast('Bitte erst anmelden')"}">
          âœ— Falsch <span class="vote-count">${ev.declined || 0}</span>
        </button>
      </div>
      ${!canVote ? '<div class="vote-voted-msg">Anmelden um abzustimmen</div>' : ''}`;
  }

  z.innerHTML = `
    <div class="event-card" style="position:relative">
      <div class="card-handle"></div>
      <button class="card-close" onclick="closeCard()">âœ•</button>
      <div class="card-cat-row">${catPill} ${liveBadge}</div>
      <div class="card-title">${ev.name}</div>
      <div class="card-time">ğŸ• ${ev.time || 'â€“'}</div>
      <div class="card-desc">${ev.description || ''}</div>
      <div class="card-poster">ğŸ‘¤ ${ev.postedBy || 'Anonym'} Â· ${ev.postedAgo || ''}</div>
      ${voteHTML}
    </div>`;
}

// â”€â”€â”€ VOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function castVote(eventId, type) {
  if (myVote(eventId)) return;
  saveVote(eventId, type);

  // Update Firestore
  try {
    const field = type === 'confirmed' ? 'confirmed' : 'declined';
    await db.collection('events').doc(eventId).update({
      [field]: firebase.firestore.FieldValue.increment(1)
    });
  } catch (e) {
    // Update local count if Firestore fails
  }

  // Update local event data immediately
  const ev = events.find(e => e.id === eventId);
  if (ev) ev[type === 'confirmed' ? 'confirmed' : 'declined'] = (ev[type === 'confirmed' ? 'confirmed' : 'declined'] || 0) + 1;

  showToast(type === 'confirmed' ? 'âœ“ Als real markiert!' : 'âœ— Als inaktiv gemeldet!');
  renderCard();
}

// â”€â”€â”€ FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(f) {
  S.filter = f;
  S.selectedId = null;
  renderHeader();
  renderCard();
  renderMarkers();
}

// â”€â”€â”€ ADD EVENT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddEvent() {
  if (!user) { showAuth(); return; }
  S.addModal = true;
  S.addForm = { name: '', description: '', time: '', category: 'music', type: 'spontaneous' };
  renderModal();
}

function closeModal() {
  S.addModal = false;
  document.getElementById('modal-zone').innerHTML = '';
}

function renderModal() {
  if (!S.addModal) return;
  const f = S.addForm;

  const catButtons = Object.entries(CATS).map(([k, v]) => {
    const sel = f.category === k ? 'selected' : '';
    return `<button class="cat-btn ${sel}" onclick="setFormCat('${k}')">
      <span class="cat-emoji">${v.emoji}</span>
      <span>${v.label}</span>
    </button>`;
  }).join('');

  document.getElementById('modal-zone').innerHTML = `
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-sheet">
      <div class="modal-title">Event melden ğŸ“</div>

      <label class="form-label">Name des Events</label>
      <input class="form-field" type="text" placeholder="z.B. Live Jazz am BÃ¼rkliplatz"
        value="${escHtml(f.name)}" oninput="S.addForm.name=this.value" maxlength="80"/>

      <label class="form-label">Typ</label>
      <div class="type-toggle">
        <button class="type-btn ${f.type==='spontaneous'?'selected':''}" onclick="setFormType('spontaneous')">ğŸ”´ Spontan / Live</button>
        <button class="type-btn ${f.type==='planned'?'selected':''}" onclick="setFormType('planned')">ğŸ“… Geplant</button>
      </div>

      <label class="form-label">Kategorie</label>
      <div class="cat-grid">${catButtons}</div>

      <label class="form-label">Uhrzeit / Wann</label>
      <input class="form-field" type="text" placeholder="z.B. Jetzt Â· 19:00â€“22:00"
        value="${escHtml(f.time)}" oninput="S.addForm.time=this.value" maxlength="50"/>

      <label class="form-label">Beschreibung</label>
      <textarea class="form-field" placeholder="Was passiert dort?" maxlength="300"
        oninput="S.addForm.description=this.value">${escHtml(f.description)}</textarea>

      <button class="btn-primary" onclick="submitEvent()">Event verÃ¶ffentlichen ğŸš€</button>
    </div>`;
}

function setFormCat(c) { S.addForm.category = c; renderModal(); }
function setFormType(t) { S.addForm.type = t; renderModal(); }

async function submitEvent() {
  const f = S.addForm;
  if (!f.name.trim()) { showToast('Bitte einen Namen eingeben'); return; }

  const btn = document.querySelector('.btn-primary');
  if (btn) { btn.disabled = true; btn.textContent = 'Wird gespeichertâ€¦'; }

  try {
    const docRef = await db.collection('events').add({
      name: f.name.trim(),
      description: f.description.trim(),
      time: f.time.trim(),
      category: f.category,
      type: f.type,
      lat: userLat,
      lng: userLng,
      confirmed: 0,
      declined: 0,
      postedBy: user.displayName || user.email?.split('@')[0] || 'Anonym',
      postedAgo: 'Gerade eben',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
    closeModal();
    showToast('ğŸ‰ Event wurde gemeldet!');
  } catch (e) {
    showToast('Fehler: ' + e.message);
    if (btn) { btn.disabled = false; btn.textContent = 'Event verÃ¶ffentlichen ğŸš€'; }
  }
}

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAuth() {
  document.getElementById('auth-zone').innerHTML = `
    <div class="auth-logo">Event<span>Spot</span></div>
    <div class="auth-sub">ZÃ¼rich Â· Entdecke was jetzt passiert</div>
    <button class="btn-google" onclick="signInGoogle()">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
      </svg>
      Mit Google anmelden
    </button>
    <button class="auth-skip" onclick="skipAuth()">Ohne Anmeldung fortfahren</button>`;
  document.getElementById('auth-zone').style.display = 'flex';
}

function skipAuth() {
  document.getElementById('auth-zone').style.display = 'none';
}

async function signInGoogle() {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  } catch (e) {
    showToast('Anmeldung fehlgeschlagen');
  }
}

auth.onAuthStateChanged(u => {
  user = u;
  document.getElementById('auth-zone').style.display = 'none';
  renderHeader();
  renderCard();
});

// â”€â”€â”€ FIRESTORE LISTENER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startListening() {
  db.collection('events')
    .orderBy('createdAt', 'desc')
    .limit(100)
    .onSnapshot(snap => {
      events = [];
      snap.forEach(doc => {
        const d = doc.data();
        events.push({
          id: doc.id,
          ...d,
          postedAgo: d.createdAt ? formatAgo(d.createdAt.toDate()) : 'kÃ¼rzlich',
        });
      });
      // Seed demo data if empty
      if (events.length === 0) seedDemoEvents();
      renderMarkers();
      renderCard();
    }, err => console.warn('Firestore:', err));
}

function formatAgo(date) {
  const mins = Math.floor((Date.now() - date) / 60000);
  if (mins < 1) return 'Gerade eben';
  if (mins < 60) return `vor ${mins} Min.`;
  return `vor ${Math.floor(mins/60)} Std.`;
}

async function seedDemoEvents() {
  const demos = [
    { name:'Live Jazz am BÃ¼rkliplatz', category:'music', type:'spontaneous', lat:47.3657, lng:8.5407, time:'Jetzt Â· 19:30â€“22:00', description:'Strassenmusiker spielen Jazz am Seeufer. Gratis, einfach vorbeikommen!', confirmed:23, declined:1, postedBy:'Lena M.' },
    { name:'Wochenmarkt Helvetiaplatz', category:'market', type:'planned', lat:47.3745, lng:8.5295, time:'Sa 07:00â€“12:00', description:'Frische lokale Produkte, KÃ¤se, Brot und Blumen. Jeden Samstag.', confirmed:67, declined:0, postedBy:'EventSpot' },
    { name:'Lagerfeuer am Mythenquai', category:'bonfire', type:'spontaneous', lat:47.3556, lng:8.5353, time:'Ab 20:00', description:'Feuer am See, Gitarrenmusik. Bring WÃ¼rstchen mit!', confirmed:41, declined:2, postedBy:'Marco S.' },
    { name:'Street Food Festival', category:'food', type:'planned', lat:47.3780, lng:8.5490, time:'Frâ€“So 11:00â€“22:00', description:'20+ Street-Food-StÃ¤nde aus aller Welt auf dem SechselÃ¤utenplatz.', confirmed:89, declined:0, postedBy:'Eventfrog (AI)' },
    { name:'Techno Night im Hive', category:'party', type:'spontaneous', lat:47.3720, lng:8.5320, time:'Ab 22:00', description:'Special guest DJ tonight. Eintritt CHF 20.', confirmed:15, declined:3, postedBy:'Club Hive' },
    { name:'Open Mic Cabaret', category:'art', type:'planned', lat:47.3810, lng:8.5440, time:'20:00â€“23:00', description:'Offene BÃ¼hne fÃ¼r Comedians und Musiker. Gratis Eintritt.', confirmed:12, declined:0, postedBy:'KulturSpot (AI)', category2:'ai' },
  ];
  for (const d of demos) {
    await db.collection('events').add({
      ...d,
      declined: d.declined || 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
  }
}

// â”€â”€â”€ MAP INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.initMapCallback = function() {
  if (mapReady) return;
  mapReady = true;
  gmap = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 47.3769, lng: 8.5417 },
    zoom: 14,
    styles: MAP_STYLE,
    disableDefaultUI: true,
    gestureHandling: 'greedy',
    clickableIcons: false,
  });
  // Close card when map background tapped
  gmap.addListener('click', () => { S.selectedId = null; renderCard(); });
  startListening();
  locateUser();
};

// â”€â”€â”€ LOCATE USER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function locateUser() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(pos => {
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;
    if (gmap) {
      gmap.panTo({ lat: userLat, lng: userLng });
      if (userMarker) userMarker.setMap(null);
      userMarker = new google.maps.Marker({
        position: { lat: userLat, lng: userLng },
        map: gmap,
        icon: {
          url: `data:image/svg+xml,${encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 22 22">
              <circle cx="11" cy="11" r="10" fill="rgba(124,92,252,0.15)" stroke="#7c5cfc" stroke-width="1.5"/>
              <circle cx="11" cy="11" r="5" fill="#7c5cfc"/>
            </svg>`
          )}`,
          scaledSize: new google.maps.Size(22, 22),
          anchor: new google.maps.Point(11, 11),
        },
        title: 'Mein Standort',
        zIndex: 1000,
      });
    }
  }, null, { enableHighAccuracy: true, timeout: 8000 });
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderHeader();

// Show auth on first visit
if (!localStorage.getItem('es_visited')) {
  localStorage.setItem('es_visited', '1');
  setTimeout(() => {
    if (!auth.currentUser) showAuth();
  }, 1400);
}

// Load Google Maps
(function() {
  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=${window.MAPS_KEY}&callback=initMapCallback&v=weekly`;
  s.async = true; s.defer = true;
  document.head.appendChild(s);
})();

// Hide splash
setTimeout(() => {
  document.getElementById('splash').classList.add('out');
}, 1200);

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
