<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="theme-color" content="#0c0a1d"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="EventSpot"/>
<title>EventSpot Zürich</title>
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="icon-192.png"/>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<style>
:root{
  --deep:#0c0a1d;--card:#161331;--surface:#1e1a3a;--elevated:#2a2550;
  --accent:#7c6aff;--accent-l:#a99cff;--accent-g:rgba(124,106,255,.22);
  --green:#34d399;--green-d:#0d9f6e;--red:#f87171;
  --t1:#eee8ff;--t2:#8b83a8;--t3:#5c5578;
  --brd:rgba(255,255,255,.06);
  --sat:env(safe-area-inset-top,0px);--sab:env(safe-area-inset-bottom,0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;overscroll-behavior:none}
body{font-family:'Outfit',system-ui,sans-serif;background:var(--deep);color:var(--t1);-webkit-tap-highlight-color:transparent;-webkit-font-smoothing:antialiased}
button{font-family:inherit;cursor:pointer;-webkit-tap-highlight-color:transparent;border:none;background:none}
input,textarea{font-family:inherit}

/* === LAYOUT: persistent zones === */
.app{display:flex;flex-direction:column;height:100vh;height:100dvh}
.z-header{flex-shrink:0;z-index:100}
.z-map{flex:1;position:relative;overflow:hidden}
#gmap{position:absolute;inset:0;width:100%;height:100%}
.z-hud{position:absolute;inset:0;pointer-events:none;z-index:10}
.z-hud>*{pointer-events:auto}
.z-card{position:absolute;bottom:0;left:0;right:0;z-index:200;pointer-events:none}
.z-card>*{pointer-events:auto}
.z-modal{position:fixed;inset:0;z-index:500;pointer-events:none}
.z-modal>*{pointer-events:auto}
.z-toast{position:fixed;top:0;left:0;right:0;z-index:900;pointer-events:none;display:flex;justify-content:center}
.z-toast>*{pointer-events:auto}
.z-auth{position:fixed;inset:0;z-index:800;display:none}

/* === SPLASH === */
.splash{position:fixed;inset:0;z-index:9999;background:radial-gradient(ellipse at 50% 30%,#1e1a3a,#0c0a1d 70%);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .5s,visibility .5s}
.splash.hide{opacity:0;visibility:hidden;pointer-events:none}
.splash h1{font-size:44px;font-weight:900;letter-spacing:-.05em}
.splash h1 b{color:var(--accent)}
.splash p{color:var(--t2);font-size:14px;margin-top:4px}
.splash .dot{width:36px;height:36px;margin-top:32px;border-radius:50%;border:3px solid var(--elevated);border-top-color:var(--accent);animation:spin .6s linear infinite}

/* === AUTH === */
.auth{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 30%,#1e1a3a,#0c0a1d 70%);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center}
.auth h1{font-size:40px;font-weight:900;letter-spacing:-.05em;margin-bottom:4px}
.auth h1 b{color:var(--accent)}
.auth p{color:var(--t2);font-size:14px;margin-bottom:32px;max-width:260px;line-height:1.5}
.auth-google{display:flex;align-items:center;gap:10px;padding:14px 28px;border-radius:14px;border:2px solid var(--brd);background:var(--surface);color:var(--t1);font-size:15px;font-weight:600}
.auth-google img{width:20px;height:20px}
.auth-skip{margin-top:14px;color:var(--t3);font-size:13px;text-decoration:underline}

/* === HEADER === */
.hdr{background:linear-gradient(180deg,#13102b,var(--deep));padding:calc(10px + var(--sat)) 14px 8px;border-bottom:1px solid var(--brd)}
.hdr-row{display:flex;justify-content:space-between;align-items:center}
.hdr-logo{font-size:21px;font-weight:900;letter-spacing:-.04em}
.hdr-logo b{color:var(--accent)}
.hdr-sub{font-size:10px;color:var(--t2);margin-top:1px;font-weight:500;display:flex;align-items:center;gap:3px}
.hdr-acts{display:flex;gap:6px;align-items:center}
.hdr-btn{height:34px;border-radius:9px;border:1.5px solid var(--brd);color:var(--t2);display:flex;align-items:center;justify-content:center;gap:4px;font-size:11px;font-weight:600;padding:0 9px;transition:all .15s}
.hdr-btn.on{background:var(--accent-g);border-color:var(--accent);color:var(--accent-l)}
.hdr-av{width:30px;height:30px;border-radius:8px;border:2px solid var(--accent);overflow:hidden}
.hdr-av img{width:100%;height:100%;object-fit:cover}

/* === FILTERS === */
.filters{display:flex;gap:5px;padding:7px 14px;overflow-x:auto;background:var(--deep);border-bottom:1px solid var(--brd);scrollbar-width:none}
.filters::-webkit-scrollbar{display:none}
.fchip{padding:4px 12px;border-radius:18px;font-size:10px;font-weight:600;white-space:nowrap;border:1.5px solid var(--brd);color:var(--t3);flex-shrink:0;transition:all .15s}
.fchip.on{background:var(--accent-g);border-color:var(--accent);color:var(--accent-l)}

/* === HUD (on-map UI) === */
.hud-legend{position:absolute;top:8px;left:8px;background:rgba(12,10,29,.85);backdrop-filter:blur(10px);border:1px solid var(--brd);border-radius:10px;padding:6px 12px;display:flex;gap:12px;font-size:10px;color:var(--t2);font-weight:500;align-items:center}
.hud-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.hud-locate{position:absolute;top:8px;right:8px;width:38px;height:38px;border-radius:11px;border:1px solid var(--brd);background:rgba(12,10,29,.85);backdrop-filter:blur(10px);color:var(--accent-l);display:flex;align-items:center;justify-content:center}
.hud-stats{position:absolute;bottom:calc(14px + var(--sab));left:10px;display:flex;gap:6px}
.hud-badge{background:rgba(12,10,29,.85);backdrop-filter:blur(10px);border:1px solid var(--brd);border-radius:10px;padding:5px 11px;font-size:11px;font-weight:600;display:flex;align-items:center;gap:4px}
.hud-fab{position:absolute;bottom:calc(14px + var(--sab));right:12px;width:52px;height:52px;border-radius:15px;background:linear-gradient(135deg,#7c6aff,#5b47e0);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 22px rgba(91,71,224,.45)}
.hud-fab:active{transform:scale(.9)}

/* === EVENT CARD === */
.card-bg{position:absolute;inset:0;background:rgba(0,0,0,.3);animation:fadeIn .2s}
.card{position:absolute;bottom:0;left:0;right:0;background:var(--card);border-radius:22px 22px 0 0;box-shadow:0 -8px 40px rgba(0,0,0,.45);max-height:62vh;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;animation:slideUp .3s cubic-bezier(.34,1.56,.64,1)}
.card-in{padding:14px 18px calc(18px + var(--sab))}
.card-grab{width:36px;height:4px;border-radius:2px;background:var(--elevated);margin:0 auto 12px}
.card-x{width:28px;height:28px;border-radius:50%;background:var(--elevated);color:var(--t2);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.pill{display:inline-flex;align-items:center;gap:3px;padding:2px 9px;border-radius:16px;font-size:10px;font-weight:600}
.card-h{font-size:18px;font-weight:800;letter-spacing:-.02em;line-height:1.2}
.card-meta{display:flex;gap:10px;flex-wrap:wrap;font-size:11px;color:var(--t2)}
.card-desc{font-size:12px;color:var(--t2);line-height:1.5;padding-left:10px;border-left:3px solid}
.cbar-bg{height:5px;border-radius:3px;background:var(--elevated);overflow:hidden}
.cbar{height:100%;border-radius:3px;transition:width .4s}

/* === VERIFY === */
.vbox{border-radius:12px;padding:10px;display:flex;align-items:center;gap:9px;border:1.5px solid;margin-bottom:12px}
.vico{width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.vt{font-size:11px;font-weight:700;margin-bottom:1px}
.vs{font-size:10px;color:var(--t3);line-height:1.3}
.vbtn{padding:6px 11px;border-radius:9px;background:linear-gradient(135deg,var(--accent),#5b47e0);color:#fff;font-size:10px;font-weight:700;white-space:nowrap}

/* === ACTION BUTTONS === */
.acts{display:flex;gap:7px}
.abtn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;border-radius:12px;font-size:13px;font-weight:700;transition:all .2s}
.abtn-y{background:linear-gradient(135deg,var(--green),var(--green-d));color:#fff;box-shadow:0 3px 14px rgba(52,211,153,.2)}
.abtn-n{background:var(--elevated);color:var(--t2);border:1.5px solid var(--brd)!important}
.abtn.off{opacity:.4;cursor:not-allowed;filter:grayscale(.3)}
.abtn-y.off{background:var(--elevated);box-shadow:none}

/* === MODAL === */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .2s}
.msheet{background:var(--card);border-radius:22px 22px 0 0;width:100%;max-width:480px;max-height:85vh;overflow-y:auto;animation:slideUp .3s cubic-bezier(.34,1.56,.64,1)}
.msheet-in{padding:14px 18px calc(22px + var(--sab))}
.msheet h2{font-size:18px;font-weight:800;letter-spacing:-.02em;margin-bottom:14px}
.flbl{font-size:10px;font-weight:700;color:var(--t2);margin-bottom:5px;display:block;text-transform:uppercase;letter-spacing:.05em}
.finput{width:100%;padding:10px 12px;border-radius:10px;border:2px solid var(--elevated);font-size:13px;outline:none;background:var(--surface);color:var(--t1);transition:border-color .2s}
.finput:focus{border-color:var(--accent)}
.finput::placeholder{color:var(--t3)}
.cgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
.cbtn{display:flex;align-items:center;gap:3px;padding:7px 5px;border-radius:9px;border:1.5px solid var(--elevated);font-size:10px;font-weight:600;color:var(--t3);transition:all .15s}
.cbtn.on{border-color:var(--cc);color:var(--cc);background:color-mix(in srgb,var(--cc) 8%,transparent)}
.dgrid{display:flex;gap:5px;flex-wrap:wrap}
.dbtn{padding:6px 11px;border-radius:9px;border:1.5px solid var(--elevated);font-size:11px;font-weight:600;color:var(--t3)}
.dbtn.on{border-color:var(--accent);color:var(--accent-l);background:var(--accent-g)}
.sendbtn{width:100%;padding:14px;border-radius:12px;font-size:14px;font-weight:700;transition:all .2s}

/* === TOAST === */
.toast{margin-top:calc(10px + var(--sat));background:var(--card);border:1px solid var(--brd);color:var(--t1);padding:9px 18px;border-radius:12px;font-size:12px;font-weight:600;box-shadow:0 6px 24px rgba(0,0,0,.4);animation:toastIn .25s}

/* === EMPTY === */
.empty{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:var(--t3);font-size:13px;pointer-events:none}
.empty .e{font-size:32px;margin-bottom:6px}

@keyframes spin{to{transform:rotate(360deg)}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes toastIn{from{transform:translateY(-14px);opacity:0}to{transform:translateY(0);opacity:1}}
</style>
</head>
<body>

<div class="splash" id="splash"><h1>Event<b>Spot</b></h1><p>Zürich · Live Events entdecken</p><div class="dot"></div></div>

<!-- PERSISTENT STRUCTURE — #gmap never gets innerHTML'd -->
<div class="app">
  <div class="z-header" id="zHeader"></div>
  <div class="z-map">
    <div id="gmap"></div>
    <div class="z-hud" id="zHud"></div>
    <div class="z-card" id="zCard"></div>
  </div>
</div>
<div class="z-modal" id="zModal"></div>
<div class="z-toast" id="zToast"></div>
<div class="z-auth" id="zAuth"></div>

<script>
/* ============================================
   CONFIG — your keys
   ============================================ */
var MAPS_KEY="AIzaSyB_fNBv6ZLw5wm9fKwGeJ12L4p6sVM0hQg";
var FB_CFG={apiKey:"AIzaSyAg6oTGoJa_Yp7flssU5OpyXvJ2KxoA0yA",authDomain:"eventspot-zurich.firebaseapp.com",projectId:"eventspot-zurich",storageBucket:"eventspot-zurich.firebasestorage.app",messagingSenderId:"210810461333",appId:"1:210810461333:web:1c8283baba7e0fef364f9c"};

/* ============================================
   ICONS (minimal inline SVGs)
   ============================================ */
function sv(d,s){return'<svg width="'+(s||16)+'" height="'+(s||16)+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'+d+'</svg>'}
var ICO={
  music:function(s){return sv('<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>',s)},
  food:function(s){return sv('<path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 002-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 00-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/>',s)},
  bonfire:function(s){return sv('<path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.07-2.14 0-5.5 3.5-7.5 0 0 .5 4 3 5.5a6 6 0 011.5 4c0 3.04-2.35 5.5-5.25 5.5h-.5C9.35 16.5 7 14.04 7 11c0-.67.12-1.3.34-1.88"/>',s)},
  party:function(s){return sv('<path d="M5.8 11.3L2 22l10.7-3.79"/><path d="M4 3h.01M22 8h.01M15 2h.01M22 20h.01"/>',s)},
  community:function(s){return sv('<path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>',s)},
  protest:function(s){return sv('<path d="M3 11l18-5v12L3 13v-2z"/><path d="M11.6 16.8a3 3 0 11-5.8-1.6"/>',s)},
  market:function(s){return sv('<path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/>',s)},
  sport:function(s){return sv('<path d="M6.5 6.5H4a1 1 0 00-1 1v9a1 1 0 001 1h2.5M17.5 6.5H20a1 1 0 011 1v9a1 1 0 01-1 1h-2.5"/><rect x="6.5" y="3" width="4" height="18" rx="1"/><rect x="13.5" y="3" width="4" height="18" rx="1"/>',s)},
  art:function(s){return sv('<circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.93 0 1.5-.75 1.5-1.5 0-.39-.15-.74-.39-1.02-.24-.29-.38-.63-.38-1.01 0-.83.67-1.5 1.5-1.5H16c3.31 0 6-2.69 6-6 0-5.52-4.48-9.5-10-9.5z"/>',s)},
  filter:function(s){return sv('<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>',s)},
  plus:function(s){return'<svg width="'+(s||16)+'" height="'+(s||16)+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>'},
  x:function(s){return sv('<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',s)},
  check:function(s){return sv('<path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',s)},
  xc:function(s){return sv('<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>',s)},
  clock:function(s){return sv('<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',s)},
  eye:function(s){return sv('<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>',s)},
  nav:function(s){return sv('<polygon points="3 11 22 2 13 21 11 13 3 11"/>',s)},
  pin:function(s){return sv('<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/>',s)},
  loc:function(s){return sv('<circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/>',s)},
};

/* ============================================
   CATEGORIES
   ============================================ */
var CATS={
  music:{ico:'music',label:'Musik',c:'#e040fb'},
  food:{ico:'food',label:'Essen',c:'#ff6d00'},
  bonfire:{ico:'bonfire',label:'Lagerfeuer',c:'#ff3d00'},
  party:{ico:'party',label:'Party',c:'#d500f9'},
  community:{ico:'community',label:'Community',c:'#00b0ff'},
  protest:{ico:'protest',label:'Demo',c:'#ff1744'},
  market:{ico:'market',label:'Markt',c:'#00c853'},
  sport:{ico:'sport',label:'Sport',c:'#2979ff'},
  art:{ico:'art',label:'Kunst',c:'#aa00ff'}
};

/* ============================================
   UTILS
   ============================================ */
var MAX_D=300;
function hav(a,b,c,d){var R=6371000,r=function(x){return x*Math.PI/180},dl=r(c-a),dn=r(d-b),x=Math.sin(dl/2)*Math.sin(dl/2)+Math.cos(r(a))*Math.cos(r(c))*Math.sin(dn/2)*Math.sin(dn/2);return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function ago(ts){if(!ts||!ts.toDate)return'';var s=Math.floor((Date.now()-ts.toDate().getTime())/1000);if(s<60)return'gerade eben';if(s<3600)return'vor '+Math.floor(s/60)+' Min';if(s<86400)return'vor '+Math.floor(s/3600)+' Std';return'vor '+Math.floor(s/86400)+' Tagen'}
function mkSvgMarker(color,count){
  var badge=count>10?'#16a34a':count>3?'#eab308':'#64748b';
  return'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="56" viewBox="0 0 48 56">'
    +'<filter id="s"><feDropShadow dx="0" dy="1" stdDeviation="2" flood-opacity=".3"/></filter>'
    +'<g filter="url(#s)"><circle cx="24" cy="22" r="18" fill="'+color+'" stroke="#fff" stroke-width="2.5"/>'
    +'<polygon points="16,36 24,52 32,36" fill="'+color+'"/></g>'
    +'<circle cx="24" cy="22" r="7" fill="rgba(255,255,255,.25)"/>'
    +'<circle cx="37" cy="8" r="9" fill="'+badge+'" stroke="#fff" stroke-width="1.5"/>'
    +'<text x="37" y="12" text-anchor="middle" fill="#fff" font-size="10" font-weight="700" font-family="Outfit,sans-serif">'+count+'</text>'
    +'</svg>'
  );
}

/* ============================================
   DARK MAP STYLE
   ============================================ */
var MAP_STYLE=[
  {elementType:"geometry",stylers:[{color:"#0c0a1d"}]},
  {elementType:"labels.text.fill",stylers:[{color:"#6b6390"}]},
  {elementType:"labels.text.stroke",stylers:[{color:"#0c0a1d"},{weight:3}]},
  {featureType:"road",elementType:"geometry",stylers:[{color:"#1a1735"}]},
  {featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#252046"}]},
  {featureType:"road.highway",elementType:"geometry",stylers:[{color:"#252046"}]},
  {featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#302a5c"}]},
  {featureType:"water",elementType:"geometry",stylers:[{color:"#0e1a2e"}]},
  {featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#1a3050"}]},
  {featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},
  {featureType:"poi.park",elementType:"geometry",stylers:[{color:"#0f1525"}]},
  {featureType:"transit",stylers:[{visibility:"off"}]},
  {featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#252046"}]},
  {featureType:"administrative.locality",elementType:"labels.text.fill",stylers:[{color:"#7c6aff"}]},
];

/* ============================================
   STATE
   ============================================ */
var gmap,db,auth,locMarker,locCircle;
var gmMarkers={};
var allEvents=[];
var userPos=null;
var S={
  user:null,sel:null,filter:'all',fOpen:false,
  modal:false,vfy:'idle',
  toast:null,tt:null,auth:true,
  fn:'',fc:'music',fd:'',fdur:'1-2 Stunden'
};

/* ============================================
   FIREBASE
   ============================================ */
firebase.initializeApp(FB_CFG);
db=firebase.firestore();
auth=firebase.auth();
var listening=false;

auth.onAuthStateChanged(function(u){
  S.user=u;
  if(u){S.auth=false;rAuth();rHeader();initMap()}
  else{S.auth=true;rAuth()}
});

function gSignIn(){var p=new firebase.auth.GoogleAuthProvider();auth.signInWithPopup(p).catch(function(){auth.signInWithRedirect(p)})}
function anonIn(){auth.signInAnonymously().catch(function(e){toast('Fehler: '+e.message)})}
function signOut(){auth.signOut();S.auth=true;rAuth()}

function listen(){
  if(listening)return;listening=true;
  db.collection('events').orderBy('createdAt','desc').onSnapshot(function(snap){
    allEvents=snap.docs.map(function(d){var o=d.data();o.id=d.id;return o});
    syncMarkers();rHud();rHeader();
    // also update card if open
    if(S.sel){var fresh=allEvents.find(function(e){return e.id===S.sel.id});if(fresh)S.sel=fresh;rCard()}
  });
}

/* ============================================
   FILTERED
   ============================================ */
function filtered(){
  var f=S.filter;
  if(f==='all')return allEvents;
  if(f==='spontaneous')return allEvents.filter(function(e){return e.type==='spontaneous'});
  if(f==='planned')return allEvents.filter(function(e){return e.type==='planned'});
  return allEvents.filter(function(e){return e.category===f});
}

/* ============================================
   MARKERS — manages google.maps.Marker objects
   Map div is NEVER touched by rendering code
   ============================================ */
function syncMarkers(){
  if(!gmap)return;
  var vis=filtered();
  var keep={};
  vis.forEach(function(e){keep[e.id]=true});

  // remove old
  Object.keys(gmMarkers).forEach(function(id){
    if(!keep[id]){gmMarkers[id].setMap(null);delete gmMarkers[id]}
  });

  // add or update
  vis.forEach(function(ev){
    var cat=CATS[ev.category]||CATS.community;
    var sp=ev.type==='spontaneous';
    var color=sp?cat.c:'#34d399';
    var cnt=ev.confirmed||0;

    if(gmMarkers[ev.id]){
      // update icon (count may have changed)
      gmMarkers[ev.id].setIcon({url:mkSvgMarker(color,cnt),scaledSize:new google.maps.Size(40,47),anchor:new google.maps.Point(20,47)});
      gmMarkers[ev.id].setPosition({lat:ev.lat,lng:ev.lng});
      return;
    }

    var m=new google.maps.Marker({
      map:gmap,
      position:{lat:ev.lat,lng:ev.lng},
      icon:{url:mkSvgMarker(color,cnt),scaledSize:new google.maps.Size(40,47),anchor:new google.maps.Point(20,47)},
      title:ev.name,
      optimized:false,
      animation:google.maps.Animation.DROP
    });
    m.addListener('click',function(){selectEv(ev.id)});
    gmMarkers[ev.id]=m;
  });
}

/* ============================================
   USER LOCATION (blue dot + accuracy circle)
   ============================================ */
function showUserLocation(){
  if(!navigator.geolocation||!gmap)return;
  navigator.geolocation.watchPosition(function(p){
    userPos={lat:p.coords.latitude,lng:p.coords.longitude};
    var pos={lat:userPos.lat,lng:userPos.lng};

    if(!locMarker){
      locMarker=new google.maps.Marker({
        map:gmap,position:pos,
        icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:'#4285F4',fillOpacity:1,strokeColor:'#fff',strokeWeight:2.5},
        title:'Dein Standort',zIndex:999
      });
      locCircle=new google.maps.Circle({
        map:gmap,center:pos,radius:p.coords.accuracy,
        fillColor:'#4285F4',fillOpacity:.1,strokeColor:'#4285F4',strokeOpacity:.3,strokeWeight:1
      });
    }else{
      locMarker.setPosition(pos);
      locCircle.setCenter(pos);
      locCircle.setRadius(p.coords.accuracy);
    }
  },function(){},{enableHighAccuracy:true,timeout:15000,maximumAge:10000});
}

function goToMe(){
  if(userPos&&gmap){gmap.panTo(userPos);gmap.setZoom(15)}
  else if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(function(p){
      gmap.panTo({lat:p.coords.latitude,lng:p.coords.longitude});gmap.setZoom(15);
    },function(){},{enableHighAccuracy:true,timeout:8000});
  }
}

/* ============================================
   ACTIONS
   ============================================ */
function selectEv(id){
  S.sel=allEvents.find(function(e){return e.id===id})||null;
  S.vfy='idle';rCard();rHud();
  if(S.sel&&gmap)gmap.panTo({lat:S.sel.lat,lng:S.sel.lng});
}
function closeCard(){S.sel=null;S.vfy='idle';rCard();rHud()}

function verify(){
  if(!navigator.geolocation){S.vfy='unavailable';rCard();return}
  S.vfy='checking';rCard();
  navigator.geolocation.getCurrentPosition(function(p){
    var d=hav(p.coords.latitude,p.coords.longitude,S.sel.lat,S.sel.lng);
    S.vfy=d<=MAX_D?'nearby':'too_far';rCard();
  },function(e){S.vfy=e.code===1?'denied':'unavailable';rCard()},{enableHighAccuracy:true,timeout:10000,maximumAge:30000});
}

function confirmEv(){if(!S.sel||S.vfy!=='nearby')return;db.collection('events').doc(S.sel.id).update({confirmed:firebase.firestore.FieldValue.increment(1)});toast('\u2705 Best\u00e4tigt! Danke.')}
function declineEv(){if(!S.sel||S.vfy!=='nearby')return;db.collection('events').doc(S.sel.id).update({declined:firebase.firestore.FieldValue.increment(1)});toast('\u274c Abgelehnt. Danke.')}

function openModal(){S.modal=true;rModal()}
function closeModal(){S.modal=false;S.fn='';S.fc='music';S.fd='';S.fdur='1-2 Stunden';rModal()}

function submitEv(){
  if(!S.fn.trim())return;
  var name=S.fn.trim(),cat=S.fc,desc=S.fd,dur=S.fdur;
  var doIt=function(lat,lng){
    db.collection('events').add({name:name,type:'spontaneous',category:cat,lat:lat,lng:lng,time:'Jetzt \u00b7 '+dur,description:desc||'Neues Event in der N\u00e4he!',confirmed:1,declined:0,postedBy:(S.user&&S.user.displayName)||'Anonym',postedByUid:(S.user&&S.user.uid)||null,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    closeModal();toast('\uD83C\uDF89 Event gemeldet!');
  };
  if(userPos){doIt(userPos.lat,userPos.lng)}
  else if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(p){doIt(p.coords.latitude,p.coords.longitude)},function(){doIt(47.3769,8.5417)},{enableHighAccuracy:true,timeout:8000})}
  else{doIt(47.3769,8.5417)}
}

function setFilter(f){S.filter=f;syncMarkers();rHeader();rHud()}
function toast(m){clearTimeout(S.tt);S.toast=m;rToast();S.tt=setTimeout(function(){S.toast=null;rToast()},2500)}

/* ============================================
   RENDER — each function updates ONLY its zone
   The map (#gmap) is NEVER touched
   ============================================ */
function rAuth(){
  var z=document.getElementById('zAuth');
  if(!S.auth){z.style.display='none';z.innerHTML='';return}
  z.style.display='block';
  z.innerHTML='<div class="auth"><h1>Event<b>Spot</b></h1><p>Entdecke spontane Events in deiner N\u00e4he. Melde dich an, um Events zu best\u00e4tigen und eigene zu erstellen.</p><button class="auth-google" onclick="gSignIn()"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt=""/>Mit Google anmelden</button><button class="auth-skip" onclick="anonIn()">Ohne Konto fortfahren</button></div>';
}

function rHeader(){
  var f=filtered(),u=S.user;
  var h='<div class="hdr"><div class="hdr-row"><div><div class="hdr-logo">Event<b>Spot</b></div><div class="hdr-sub">'+ICO.nav(9)+' Z\u00fcrich \u00b7 '+f.length+' Events</div></div><div class="hdr-acts"><button class="hdr-btn '+(S.fOpen?'on':'')+'" onclick="S.fOpen=!S.fOpen;rHeader()">'+ICO.filter(13)+' Filter</button>';
  if(u&&!u.isAnonymous)h+='<div class="hdr-av" onclick="if(confirm(\'Abmelden?\'))signOut()"><img src="'+(u.photoURL||'')+'" alt=""/></div>';
  else h+='<button class="hdr-btn" onclick="gSignIn()">Anmelden</button>';
  h+='</div></div></div>';
  if(S.fOpen){
    var chips=[{k:'all',l:'Alle'},{k:'spontaneous',l:'\uD83D\uDFE3 Spontan'},{k:'planned',l:'\uD83D\uDFE2 Geplant'}];
    Object.keys(CATS).forEach(function(k){chips.push({k:k,l:CATS[k].label})});
    h+='<div class="filters">';chips.forEach(function(c){h+='<button class="fchip '+(S.filter===c.k?'on':'')+'" onclick="setFilter(\''+c.k+'\')">'+c.l+'</button>'});h+='</div>';
  }
  document.getElementById('zHeader').innerHTML=h;
}

function rHud(){
  var live=allEvents.filter(function(e){return e.type==='spontaneous'}).length;
  var plan=allEvents.filter(function(e){return e.type==='planned'}).length;
  var h='<div class="hud-legend"><span style="display:flex;align-items:center;gap:4px"><span class="hud-dot" style="background:var(--accent);box-shadow:0 0 5px var(--accent)"></span>Spontan</span><span style="display:flex;align-items:center;gap:4px"><span class="hud-dot" style="background:var(--green);box-shadow:0 0 5px var(--green)"></span>Geplant</span></div>';
  h+='<button class="hud-locate" onclick="goToMe()">'+ICO.loc(19)+'</button>';
  if(!S.sel){
    h+='<div class="hud-stats"><div class="hud-badge" style="color:var(--accent-l)"><span class="hud-dot" style="background:var(--accent)"></span>'+live+' Live</div><div class="hud-badge" style="color:var(--green)"><span class="hud-dot" style="background:var(--green)"></span>'+plan+' Geplant</div></div>';
    h+='<button class="hud-fab" onclick="openModal()">'+ICO.plus(24)+'</button>';
  }
  if(!allEvents.length&&!S.sel)h+='<div class="empty"><div class="e">\uD83D\uDCCD</div>Noch keine Events.<br>Tippe <b>+</b> um das erste zu melden!</div>';
  document.getElementById('zHud').innerHTML=h;
}

function rCard(){
  var z=document.getElementById('zCard'),s=S.sel;
  if(!s){z.innerHTML='';return}
  var v=S.vfy,ok=v==='nearby';
  var cat=CATS[s.category]||CATS.community,sp=s.type==='spontaneous';
  var t=(s.confirmed||0)+(s.declined||0),ratio=t>0?((s.confirmed||0)/t)*100:100;
  var bc=ratio>80?'linear-gradient(90deg,#34d399,#0d9f6e)':ratio>50?'linear-gradient(90deg,#fbbf24,#d97706)':'linear-gradient(90deg,#f87171,#dc2626)';
  var tc=sp?cat.c:'#34d399';var posted=ago(s.createdAt)||(s.postedAgo||'');
  var dist='';if(userPos){var dm=Math.round(hav(userPos.lat,userPos.lng,s.lat,s.lng));dist=dm<1000?(dm+'m entfernt'):(Math.round(dm/100)/10+'km entfernt')}

  // verify
  var vb=ok?'rgba(52,211,153,.08)':v==='too_far'?'rgba(248,113,113,.08)':'var(--surface)';
  var vr=ok?'#34d39940':v==='too_far'?'#f8717140':'var(--elevated)';
  var vi=v==='checking'?'<div style="width:14px;height:14px;border-radius:50%;border:2px solid var(--elevated);border-top-color:var(--accent);animation:spin .6s linear infinite"></div>':ok?ICO.nav(14):ICO.pin(14);
  var vtc=ok?'var(--green)':v==='too_far'?'var(--red)':'var(--t1)';
  var vt=v==='checking'?'Standort wird gepr\u00fcft\u2026':ok?'Du bist in der N\u00e4he \u2713':v==='too_far'?'Zu weit weg':v==='denied'?'Standortzugriff verweigert':v==='unavailable'?'Standort nicht verf\u00fcgbar':'Standort-Verifizierung n\u00f6tig';
  var vsub=v==='checking'?'Einen Moment\u2026':ok?'Du kannst jetzt abstimmen.':v==='too_far'?'Innerhalb 300m sein zum Abstimmen.':v==='denied'?'Erlaube Standortzugriff im Browser.':v==='unavailable'?'Geolocation nicht unterst\u00fctzt.':'Du musst vor Ort sein.';
  var vBtn=v==='idle'||v==='too_far'||v==='denied';

  z.innerHTML='<div class="card-bg" onclick="closeCard()"></div><div class="card" onclick="event.stopPropagation()"><div class="card-in">'
    +'<div class="card-grab"></div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px"><div style="flex:1"><div style="display:flex;gap:5px;margin-bottom:5px;flex-wrap:wrap"><span class="pill" style="background:'+tc+'22;color:'+tc+'">'+ICO[cat.ico](10)+' '+(sp?'Spontan':'Geplant')+'</span><span class="pill" style="background:var(--elevated);color:var(--t2)">'+cat.label+'</span>'+(dist?'<span class="pill" style="background:var(--elevated);color:var(--accent-l)">'+ICO.pin(9)+' '+dist+'</span>':'')+'</div><h2 class="card-h">'+esc(s.name)+'</h2></div><button class="card-x" onclick="closeCard()">'+ICO.x(13)+'</button></div>'
    +'<div class="card-meta" style="margin-bottom:8px"><span style="display:flex;align-items:center;gap:3px;font-weight:500">'+ICO.clock(11)+' '+esc(s.time||'')+'</span><span style="color:var(--t3);font-size:10px">'+ICO.eye(10)+' '+esc(s.postedBy||'Anonym')+' \u00b7 '+posted+'</span></div>'
    +'<p class="card-desc" style="border-color:'+tc+';margin-bottom:12px">'+esc(s.description||'')+'</p>'
    +'<div style="margin-bottom:12px"><div class="cred-row" style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:10px;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.04em">Glaubw\u00fcrdigkeit</span><span style="font-size:10px;color:var(--t3)">'+(s.confirmed||0)+' \u2713 \u00b7 '+(s.declined||0)+' \u2717</span></div><div class="cbar-bg"><div class="cbar" style="background:'+bc+';width:'+ratio+'%"></div></div></div>'
    +'<div class="vbox" style="background:'+vb+';border-color:'+vr+'"><div class="vico" style="background:'+(ok?'rgba(52,211,153,.15)':v==='too_far'?'rgba(248,113,113,.15)':'var(--elevated)')+';color:'+vtc+'">'+vi+'</div><div style="flex:1"><div class="vt" style="color:'+vtc+'">'+vt+'</div><div class="vs">'+vsub+'</div></div>'+(vBtn?'<button class="vbtn" onclick="verify()">\uD83D\uDCCD Pr\u00fcfen</button>':'')+'</div>'
    +'<div class="acts"><button class="abtn abtn-y '+(ok?'':'off')+'" '+(ok?'onclick="confirmEv()"':'')+'>'+ICO.check(15)+' Best\u00e4tigen</button><button class="abtn abtn-n '+(ok?'':'off')+'" '+(ok?'onclick="declineEv()"':'')+'>'+ICO.xc(15)+' Ablehnen</button></div>'
    +(!ok&&v!=='checking'?'<p style="text-align:center;font-size:10px;color:var(--t3);margin-top:6px">\uD83D\uDCCD Standort verifizieren zum Abstimmen</p>':'')
    +'</div></div>';
}

function rModal(){
  var z=document.getElementById('zModal');
  if(!S.modal){z.innerHTML='';z.style.pointerEvents='none';return}
  z.style.pointerEvents='auto';
  var cats='';Object.keys(CATS).forEach(function(k){var c=CATS[k];cats+='<button class="cbtn '+(S.fc===k?'on':'')+'" style="--cc:'+c.c+'" onclick="S.fc=\''+k+'\';rModal()">'+ICO[c.ico](11)+' '+c.label+'</button>'});
  var durs='';["< 1 Stunde","1-2 Stunden","3-5 Stunden","Ganzer Tag"].forEach(function(d){durs+='<button class="dbtn '+(S.fdur===d?'on':'')+'" onclick="S.fdur=\''+d.replace(/'/g,"\\'")+'\';rModal()">'+d+'</button>'});
  var ok=S.fn.trim().length>0;
  z.innerHTML='<div class="mbg" onclick="closeModal()"><div class="msheet" onclick="event.stopPropagation()"><div class="msheet-in"><div class="card-grab"></div><h2>Neues Event melden \uD83D\uDCCD</h2><label class="flbl">Event Name *</label><input class="finput" placeholder="z.B. Live Musik am See" value="'+esc(S.fn)+'" oninput="S.fn=this.value" style="margin-bottom:12px"/><label class="flbl">Kategorie</label><div class="cgrid" style="margin-bottom:12px">'+cats+'</div><label class="flbl">Beschreibung</label><textarea class="finput" placeholder="Was passiert dort?" rows="3" oninput="S.fd=this.value" style="margin-bottom:12px;resize:vertical">'+esc(S.fd)+'</textarea><label class="flbl">Gesch\u00e4tzte Dauer</label><div class="dgrid" style="margin-bottom:18px">'+durs+'</div><button class="sendbtn" style="background:'+(ok?'linear-gradient(135deg,#7c6aff,#5b47e0)':'var(--elevated)')+';color:'+(ok?'#fff':'var(--t3)')+'" '+(ok?'onclick="submitEv()"':'')+'>Event melden \uD83D\uDE80</button></div></div></div>';
}

function rToast(){document.getElementById('zToast').innerHTML=S.toast?'<div class="toast">'+S.toast+'</div>':''}

/* ============================================
   MAP INIT (runs once, never again)
   ============================================ */
var mapDone=false;
function initMap(){
  if(mapDone||S.auth||!window.google)return;
  var el=document.getElementById('gmap');if(!el)return;
  mapDone=true;
  gmap=new google.maps.Map(el,{
    center:{lat:47.3769,lng:8.5417},zoom:14,
    styles:MAP_STYLE,
    disableDefaultUI:true,
    zoomControl:false,mapTypeControl:false,streetViewControl:false,fullscreenControl:false,
    gestureHandling:'greedy',
    clickableIcons:false
  });
  listen();
  rHud();
  showUserLocation();
  // center on user
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(function(p){
      gmap.panTo({lat:p.coords.latitude,lng:p.coords.longitude});
    },function(){},{timeout:5000});
  }
}

window.initMapCb=function(){initMap()};
(function(){var s=document.createElement('script');s.src='https://maps.googleapis.com/maps/api/js?key='+MAPS_KEY+'&callback=initMapCb&v=weekly';s.async=true;s.defer=true;document.head.appendChild(s)})();

/* ============================================
   BOOT
   ============================================ */
rAuth();
setTimeout(function(){document.getElementById('splash').classList.add('hide')},1000);
if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(function(){});
</script>
</body>
</html>
